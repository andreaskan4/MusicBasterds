@page "/upload"
@using MusicBasterds.Models
@inject AlbumService AlbumService
@inject AuthService AuthService
@inject NavigationManager Nav
@using Microsoft.AspNetCore.Components.Forms

<div class="neon-upload-container">
    <div class="upload-header">
        <h1 class="neon-title">📀 Upload Album</h1>
        <div class="title-underline"></div>
        <p class="neon-subtitle">// Share your music discoveries with the community</p>
    </div>

    @if (SuccessMessage != null)
    {
        <div class="neon-alert neon-alert-success">
            <span class="alert-icon">✓</span>
            <span>@SuccessMessage</span>
        </div>
    }

    @if (ErrorMessage != null)
    {
        <div class="neon-alert neon-alert-danger">
            <span class="alert-icon">✗</span>
            <span>@ErrorMessage</span>
        </div>
    }

    <div class="upload-form-wrapper">
        <EditForm Model="@AlbumModel" OnValidSubmit="HandleSubmit">
            <DataAnnotationsValidator />

            <div class="form-grid">
                <!-- Album Title -->
                <div class="form-section full-width">
                    <label class="neon-label">
                        <span class="label-icon">🎵</span> Album Title *
                    </label>
                    <input class="neon-input"
                           @bind="AlbumModel.Title"
                           placeholder="Enter album title..."
                           required />
                </div>

                <!-- Artist -->
                <div class="form-section full-width">
                    <label class="neon-label">
                        <span class="label-icon">🎤</span> Artist *
                    </label>
                    <input class="neon-input"
                           @bind="AlbumModel.Artist"
                           placeholder="Enter artist name..."
                           required />
                </div>

                <!-- Genre -->
                <div class="form-section">
                    <label class="neon-label">
                        <span class="label-icon">🎸</span> Genre *
                    </label>
                    <select class="neon-select" @bind="AlbumModel.Genre">
                        @foreach (var genre in Genres)
                        {
                            <option value="@genre">@genre</option>
                        }
                    </select>
                </div>

                <!-- Album Image -->
                <div class="form-section">
                    <label class="neon-label">
                        <span class="label-icon">🖼️</span> Album Cover
                        <span class="optional-badge">optional</span>
                    </label>
                    <div class="image-upload-zone">
                        <InputFile OnChange="HandleImageSelected" class="file-input" id="fileInput" />
                        <label for="fileInput" class="file-label">
                            @if (PreviewImage == null)
                            {
                                <div class="upload-placeholder">
                                    <span class="upload-icon">📁</span>
                                    <span>Click to upload</span>
                                    <span class="upload-hint">Max 5MB</span>
                                </div>
                            }
                            else
                            {
                                <img src="@PreviewImage" class="preview-image" alt="Album preview" />
                                <div class="change-image-overlay">
                                    <span>Change Image</span>
                                </div>
                            }
                        </label>
                    </div>
                </div>

                <!-- Album Links -->
                <div class="form-section full-width">
                    <label class="neon-label">
                        <span class="label-icon">🔗</span> Album Links *
                        <span class="link-count">(@AlbumModel.Links.Count)</span>
                    </label>
                    <div class="links-container">
                        @for (int i = 0; i < AlbumModel.Links.Count; i++)
                        {
                            var index = i;
                            <div class="link-input-group">
                                <span class="link-number">@(index + 1)</span>
                                <input type="url"
                                       class="neon-input link-input"
                                       value="@AlbumModel.Links[index].Url"
                                       @oninput="@(e => UpdateLink(index, e.Value?.ToString() ?? ""))"
                                       placeholder="https://spotify.com/..." />

                                @if (AlbumModel.Links.Count > 1)
                                {
                                    <button type="button"
                                            class="neon-btn-icon neon-btn-danger-icon"
                                            @onclick="() => RemoveLink(index)">
                                        ✗
                                    </button>
                                }
                            </div>
                        }
                        <button type="button" class="neon-btn-sm add-link-btn" @onclick="AddLink">
                            <span class="btn-icon">+</span> Add Another Link
                        </button>
                    </div>
                </div>

                <!-- Description -->
                <div class="form-section full-width">
                    <label class="neon-label">
                        <span class="label-icon">📝</span> Description *
                        <span class="word-counter @(WordCount >= 50 ? "valid" : "invalid")">
                            @WordCount / 50 words
                        </span>
                    </label>
                    <textarea class="neon-textarea"
                              @bind="AlbumModel.Description"
                              rows="8"
                              placeholder="Share your thoughts about this album... (minimum 50 words)"
                              required></textarea>
                    <div class="description-help">
                        💡 Tip: Include what makes this album special, standout tracks, or why others should listen.
                    </div>
                </div>
            </div>

            <!-- Validation Summary -->
            <div class="validation-panel">
                <div class="validation-title">
                    <span class="validation-icon">⚠️</span> Submission Requirements
                </div>
                <div class="validation-checklist">
                    <div class="validation-item @(string.IsNullOrWhiteSpace(AlbumModel.Title) ? "" : "valid")">
                        @(string.IsNullOrWhiteSpace(AlbumModel.Title) ? "☐" : "☑") Album title provided
                    </div>
                    <div class="validation-item @(string.IsNullOrWhiteSpace(AlbumModel.Artist) ? "" : "valid")">
                        @(string.IsNullOrWhiteSpace(AlbumModel.Artist) ? "☐" : "☑") Artist name provided
                    </div>
                    <div class="validation-item @(AlbumModel.Links.Count > 0 && !string.IsNullOrWhiteSpace(AlbumModel.Links[0].Url) ? "valid" : "")">
                        @(AlbumModel.Links.Count > 0 && !string.IsNullOrWhiteSpace(AlbumModel.Links[0].Url) ? "☑" : "☐") At least one valid link
                    </div>
                    <div class="validation-item @(WordCount >= 50 ? "valid" : "")">
                        @(WordCount >= 50 ? "☑" : "☐") Description has 50+ words
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="submit-section">
                <button type="submit"
                        class="neon-btn-submit @(IsFormValid ? "" : "disabled")"
                        disabled="@(!IsFormValid)">
                    <span class="submit-icon">🚀</span>
                    @(IsFormValid ? "Submit Album" : "Complete Required Fields")
                </button>
                <button type="button" class="neon-btn-cancel" @onclick="Cancel">
                    Cancel
                </button>
            </div>
        </EditForm>
    </div>
</div>

@code {
    private Album AlbumModel = new Album
    {
        Links = new List<LinkItem> { new LinkItem() },
        Genre = "???"
    };

    private string? SuccessMessage;
    private string? ErrorMessage;
    private string? PreviewImage;

    private List<string> Genres = new List<string>
    {
        "Rock","Pop","Hip-Hop","Electronic","Jazz","Classical","R&B","Metal",
        "Folk","Reggae","Country","Blues","Punk","Soul","Latin","Funk",
        "Ambient","Experimental","Indie","???"
    };

    private int WordCount => string.IsNullOrWhiteSpace(AlbumModel.Description)
        ? 0
        : AlbumModel.Description.Split(' ', StringSplitOptions.RemoveEmptyEntries).Length;

    private bool IsFormValid =>
        AlbumModel.Links.Count > 0 &&
        !string.IsNullOrWhiteSpace(AlbumModel.Links[0].Url) &&
        WordCount >= 50 &&
        !string.IsNullOrWhiteSpace(AlbumModel.Title) &&
        !string.IsNullOrWhiteSpace(AlbumModel.Artist);

    private void AddLink() => AlbumModel.Links.Add(new LinkItem());

    private void RemoveLink(int index)
    {
        if (index >= 0 && index < AlbumModel.Links.Count)
            AlbumModel.Links.RemoveAt(index);
    }

    private async Task HandleSubmit()
    {
        ErrorMessage = null;
        SuccessMessage = null;

        if (!IsFormValid)
        {
            ErrorMessage = "Please fill in all required fields, at least one valid link, and a 50-word description.";
            return;
        }

        var currentUser = await AuthService.GetCurrentUserAsync();
        if (currentUser == null)
        {
            ErrorMessage = "You must be logged in to upload.";
            return;
        }

        AlbumModel.UserName = currentUser.Username;
        AlbumModel.UploadDate = DateTime.Now;

        await AlbumService.AddAlbumAsync(AlbumModel);

        SuccessMessage = "Album uploaded successfully!";

        // Reset form
        AlbumModel = new Album
        {
            Links = new List<LinkItem> { new LinkItem() },
            Genre = "???"
        };
        PreviewImage = null;
    }

    private async Task HandleImageSelected(InputFileChangeEventArgs e)
    {
        var file = e.File;
        if (file != null)
        {
            using var stream = file.OpenReadStream(5_000_000);
            var buffer = new byte[file.Size];
            await stream.ReadAsync(buffer);
            AlbumModel.Image = buffer;

            PreviewImage = $"data:{file.ContentType};base64,{Convert.ToBase64String(buffer)}";
        }
    }

    private void UpdateLink(int index, string value)
    {
        if (index >= 0 && index < AlbumModel.Links.Count)
        {
            AlbumModel.Links[index].Url = value;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/home");
    }
}

<style>
    .neon-upload-container {
        background: #000000;
        min-height: 100vh;
        padding: 2rem;
        color: #00ff41;
        font-family: 'Courier New', monospace;
    }

    .upload-header {
        text-align: center;
        margin-bottom: 3rem;
    }

    .neon-title {
        font-size: 3rem;
        font-weight: bold;
        color: #00ff41;
        text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41, 0 0 40px #00ff41;
        margin-bottom: 1rem;
        letter-spacing: 2px;
        animation: pulse 2s ease-in-out infinite;
    }

    @@keyframes pulse {
        0%, 100%

    {
        text-shadow: 0 0 10px #00ff41, 0 0 20px #00ff41, 0 0 40px #00ff41;
    }

    50% {
        text-shadow: 0 0 20px #00ff41, 0 0 40px #00ff41, 0 0 80px #00ff41;
    }

    }

    .title-underline {
        height: 2px;
        width: 150px;
        margin: 0 auto 1rem;
        background: linear-gradient(90deg, transparent, #00ff41, transparent);
        box-shadow: 0 0 10px #00ff41;
    }

    .neon-subtitle {
        font-size: 1.1rem;
        color: #00ff41;
        opacity: 0.8;
        letter-spacing: 1px;
    }

    .neon-alert {
        background: linear-gradient(135deg, rgba(0, 255, 65, 0.1), rgba(0, 255, 65, 0.05));
        border: 2px solid #00ff41;
        border-radius: 8px;
        padding: 1rem 1.5rem;
        margin: 1.5rem 0;
        box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        display: flex;
        align-items: center;
        gap: 1rem;
        animation: slideIn 0.5s ease-out;
    }

    @@keyframes slideIn {
        from

    {
        opacity: 0;
        transform: translateY(-20px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .neon-alert-success {
        border-color: #00ff41;
        background: linear-gradient(135deg, rgba(0, 255, 65, 0.15), rgba(0, 255, 65, 0.08));
    }

    .neon-alert-danger {
        border-color: #ff0040;
        background: linear-gradient(135deg, rgba(255, 0, 64, 0.15), rgba(255, 0, 64, 0.08));
        color: #ff0040;
    }

    .alert-icon {
        font-size: 1.5rem;
        animation: blink 1.5s ease-in-out infinite;
    }

    @@keyframes blink {
        0%, 100%

    {
        opacity: 1;
    }

    50% {
        opacity: 0.5;
    }

    }

    .upload-form-wrapper {
        max-width: 1000px;
        margin: 0 auto;
        background: rgba(0, 255, 65, 0.02);
        border: 2px solid #00ff41;
        border-radius: 12px;
        padding: 2.5rem;
        box-shadow: 0 0 30px rgba(0, 255, 65, 0.2);
    }

    .form-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 2rem;
        margin-bottom: 2rem;
    }

    .form-section {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

        .form-section.full-width {
            grid-column: 1 / -1;
        }

    .neon-label {
        color: #00ff41;
        font-size: 1rem;
        font-weight: bold;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-shadow: 0 0 5px #00ff41;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .label-icon {
        font-size: 1.2rem;
        filter: drop-shadow(0 0 5px #00ff41);
    }

    .optional-badge {
        font-size: 0.7rem;
        background: rgba(0, 255, 65, 0.2);
        padding: 0.2rem 0.5rem;
        border-radius: 4px;
        border: 1px solid #00ff41;
        text-transform: lowercase;
        margin-left: auto;
    }

    .neon-input {
        background: rgba(0, 255, 65, 0.05);
        border: 2px solid #00ff41;
        color: #00ff41;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        transition: all 0.3s ease;
        box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.1);
    }

        .neon-input:focus {
            outline: none;
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4), inset 0 0 20px rgba(0, 255, 65, 0.15);
            transform: translateY(-2px);
        }

        .neon-input::placeholder {
            color: #00ff41;
            opacity: 0.5;
        }

    .neon-select {
        background: rgba(0, 255, 65, 0.05);
        border: 2px solid #00ff41;
        color: #00ff41;
        padding: 0.75rem 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

        .neon-select:focus {
            outline: none;
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4);
        }

        .neon-select option {
            background: #000000;
            color: #00ff41;
        }

    .image-upload-zone {
        position: relative;
    }

    .file-input {
        display: none;
    }

    .file-label {
        display: block;
        width: 100%;
        min-height: 200px;
        background: rgba(0, 255, 65, 0.05);
        border: 2px dashed #00ff41;
        border-radius: 8px;
        cursor: pointer;
        transition: all 0.3s ease;
        position: relative;
        overflow: hidden;
    }

        .file-label:hover {
            background: rgba(0, 255, 65, 0.1);
            border-color: #00ff41;
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.3);
        }

    .upload-placeholder {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        height: 200px;
        gap: 0.5rem;
    }

    .upload-icon {
        font-size: 3rem;
        opacity: 0.6;
        filter: drop-shadow(0 0 10px #00ff41);
    }

    .upload-hint {
        font-size: 0.8rem;
        opacity: 0.6;
    }

    .preview-image {
        width: 100%;
        height: 200px;
        object-fit: cover;
        border-radius: 6px;
    }

    .change-image-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 255, 65, 0.9);
        color: #000000;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        opacity: 0;
        transition: opacity 0.3s ease;
    }

    .file-label:hover .change-image-overlay {
        opacity: 1;
    }

    .links-container {
        display: flex;
        flex-direction: column;
        gap: 1rem;
    }

    .link-count {
        font-size: 0.8rem;
        opacity: 0.7;
        margin-left: auto;
    }

    .link-input-group {
        display: flex;
        align-items: center;
        gap: 0.75rem;
        animation: slideIn 0.3s ease-out;
    }

    .link-number {
        background: rgba(0, 255, 65, 0.2);
        color: #00ff41;
        width: 30px;
        height: 30px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 0.9rem;
        border: 1px solid #00ff41;
        flex-shrink: 0;
    }

    .link-input {
        flex: 1;
    }

    .neon-btn-icon {
        background: transparent;
        border: 2px solid #00ff41;
        color: #00ff41;
        width: 35px;
        height: 35px;
        border-radius: 6px;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 1.2rem;
        font-weight: bold;
        flex-shrink: 0;
    }

        .neon-btn-icon:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.5);
            transform: scale(1.1);
        }

    .neon-btn-danger-icon {
        border-color: #ff0040;
        color: #ff0040;
    }

        .neon-btn-danger-icon:hover {
            background: rgba(255, 0, 64, 0.2);
            box-shadow: 0 0 15px rgba(255, 0, 64, 0.5);
        }

    .neon-btn-sm {
        background: transparent;
        color: #00ff41;
        border: 2px solid #00ff41;
        padding: 0.6rem 1.2rem;
        font-size: 0.9rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 6px;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

        .neon-btn-sm:hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 65, 0.4);
            transform: translateY(-2px);
        }

    .btn-icon {
        font-size: 1.2rem;
    }

    .add-link-btn {
        align-self: flex-start;
    }

    .neon-textarea {
        background: rgba(0, 255, 65, 0.05);
        border: 2px solid #00ff41;
        color: #00ff41;
        padding: 1rem;
        border-radius: 6px;
        font-family: 'Courier New', monospace;
        font-size: 1rem;
        resize: vertical;
        transition: all 0.3s ease;
        box-shadow: inset 0 0 10px rgba(0, 255, 65, 0.1);
        line-height: 1.6;
    }

        .neon-textarea:focus {
            outline: none;
            background: rgba(0, 255, 65, 0.1);
            box-shadow: 0 0 20px rgba(0, 255, 65, 0.4), inset 0 0 20px rgba(0, 255, 65, 0.15);
        }

        .neon-textarea::placeholder {
            color: #00ff41;
            opacity: 0.5;
        }

    .word-counter {
        margin-left: auto;
        font-size: 0.9rem;
        padding: 0.2rem 0.6rem;
        border-radius: 4px;
        border: 1px solid #00ff41;
        background: rgba(0, 255, 65, 0.1);
    }

        .word-counter.valid {
            color: #00ff41;
            border-color: #00ff41;
            box-shadow: 0 0 10px rgba(0, 255, 65, 0.3);
        }

        .word-counter.invalid {
            color: #ff0040;
            border-color: #ff0040;
            background: rgba(255, 0, 64, 0.1);
        }

    .description-help {
        font-size: 0.85rem;
        opacity: 0.7;
        font-style: italic;
        margin-top: 0.5rem;
    }

    .validation-panel {
        background: rgba(0, 255, 65, 0.05);
        border: 2px solid #00ff41;
        border-radius: 8px;
        padding: 1.5rem;
        margin: 2rem 0;
    }

    .validation-title {
        font-size: 1.1rem;
        font-weight: bold;
        color: #00ff41;
        margin-bottom: 1rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .validation-icon {
        font-size: 1.3rem;
        filter: drop-shadow(0 0 5px #00ff41);
    }

    .validation-checklist {
        display: flex;
        flex-direction: column;
        gap: 0.75rem;
    }

    .validation-item {
        color: #ff0040;
        padding: 0.5rem;
        border-left: 3px solid #ff0040;
        background: rgba(255, 0, 64, 0.05);
        border-radius: 4px;
        transition: all 0.3s ease;
    }

        .validation-item.valid {
            color: #00ff41;
            border-left-color: #00ff41;
            background: rgba(0, 255, 65, 0.05);
        }

    .submit-section {
        display: flex;
        gap: 1rem;
        justify-content: center;
        margin-top: 2rem;
    }

    .neon-btn-submit {
        background: transparent;
        color: #00ff41;
        border: 3px solid #00ff41;
        padding: 1rem 2.5rem;
        font-size: 1.1rem;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 2px;
        display: flex;
        align-items: center;
        gap: 0.75rem;
        position: relative;
        overflow: hidden;
    }

        .neon-btn-submit::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(0, 255, 65, 0.3), transparent);
            transition: left 0.5s ease;
        }

        .neon-btn-submit:hover::before {
            left: 100%;
        }

        .neon-btn-submit:not(.disabled):hover {
            background: rgba(0, 255, 65, 0.2);
            box-shadow: 0 0 30px rgba(0, 255, 65, 0.6), 0 0 50px rgba(0, 255, 65, 0.4);
            transform: translateY(-3px);
        }

        .neon-btn-submit.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            border-color: #666;
            color: #666;
        }

    .submit-icon {
        font-size: 1.3rem;
        filter: drop-shadow(0 0 5px #00ff41);
    }

    .neon-btn-cancel {
        background: transparent;
        color: #ff0040;
        border: 2px solid #ff0040;
        padding: 1rem 2rem;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
        border-radius: 8px;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

        .neon-btn-cancel:hover {
            background: rgba(255, 0, 64, 0.2);
            box-shadow: 0 0 20px rgba(255, 0, 64, 0.5);
            transform: translateY(-3px);
        }

    /* Mobile Responsive */
    @@media (max-width: 768px) {
        .neon-upload-container

    {
        padding: 1rem;
    }

    .neon-title {
        font-size: 2rem;
    }

    .upload-form-wrapper {
        padding: 1.5rem;
    }

    .form-grid {
        grid-template-columns: 1fr;
        gap: 1.5rem;
    }

    .form-section {
        grid-column: 1 / -1 !important;
    }

    .submit-section {
        flex-direction: column;
    }

    .neon-btn-submit,
    .neon-btn-cancel {
        width: 100%;
        justify-content: center;
    }

    }

    /* Animation for form load */
    @@keyframes fadeInUp {
        from

    {
        opacity: 0;
        transform: translateY(30px);
    }

    to {
        opacity: 1;
        transform: translateY(0);
    }

    }

    .upload-form-wrapper {
        animation: fadeInUp 0.6s ease-out;
    }
</style>